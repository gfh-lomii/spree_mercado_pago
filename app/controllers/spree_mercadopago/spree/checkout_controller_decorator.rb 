module SpreeMercadopago::Spree
  module CheckoutControllerDecorator
    def self.prepended(base)
      base.before_action :pay_with_mercadopago, only: :update
    end

    private

    def pay_with_mercadopago
      return unless params[:state] == 'payment'
      return if params[:order].blank? || params[:order][:payments_attributes].blank?

      pm_id = params[:order][:payments_attributes].first[:payment_method_id]
      payment_method = Spree::PaymentMethod.find(pm_id)

      if payment_method && payment_method.kind_of?(Spree::PaymentMethod::MercadoPago)
        payment_number = mercadopago_create_payment(payment_method)
        mercadopago_error && return unless payment_number.present?

        # TODO pay with mercadopago
        puts ">>>> TODO pay with mercadopago"
      end

    rescue StandardError => e
      mercadopago_error(e)
    end

    def mercadopago_create_payment(payment_method)
      payment = @order.payments.build(payment_method_id: payment_method.id, amount: @order.total, state: 'checkout')

      unless payment.save
        flash[:error] = payment.errors.full_messages.join("\n")
        redirect_to checkout_state_path(@order.state) && return
      end

      unless payment.pend!
        flash[:error] = payment.errors.full_messages.join("\n")
        redirect_to checkout_state_path(@order.state) && return
      end

      payment.number
    end

    def mercadopago_error(e = nil)
      @order.errors[:base] << "pagofacil error #{e.try(:message)}"
      render :edit
    end
  end
end

::Spree::CheckoutController.prepend SpreeMercadopago::Spree::CheckoutControllerDecorator